WITH 

datos_alumno AS (
    SELECT 
        a.id_alumno,
        a.avance_semestre AS semestre_ideal
    FROM alumnos a
    WHERE a.id_alumno = {{ID_ALUMNO}}
),

asignaturas_pendientes AS (
    SELECT 
        asig.cod_asignatura,
        asig.nombre,
        asig.semestre
    FROM asignaturas asig
    LEFT JOIN historial h 
        ON h.cod_asignatura = asig.cod_asignatura
        AND h.id_alumno = {{ID_ALUMNO}}
    WHERE h.estado IS NULL 
       OR h.estado != 'Aprobado'
),

conteo_dependencias AS (
    SELECT 
        p.cod_prerrequisito AS cod_asignatura,
        COUNT(*) AS dependencias
    FROM prerrequisitos p
    GROUP BY p.cod_prerrequisito
)

SELECT 
    ap.cod_asignatura,
    ap.nombre,
    ap.semestre,
    da.semestre_ideal,
    
  
    COALESCE(cd.dependencias, 0) AS dependencias_calc,
    
    CASE
        WHEN ap.semestre < da.semestre_ideal 
             AND COALESCE(cd.dependencias, 0) >= 2 
            THEN 'Atrasada y prerrequisito de múltiples asignaturas'
        WHEN ap.semestre = da.semestre_ideal 
            THEN 'Corresponde al semestre actual'
        WHEN ap.semestre < da.semestre_ideal 
            THEN 'Asignatura atrasada'
        WHEN COALESCE(cd.dependencias, 0) >= 2 
            THEN 'Prerrequisito de múltiples asignaturas futuras'
        ELSE 'No crítica'
    END AS motivo_critico,

    CASE
        WHEN ap.semestre < da.semestre_ideal 
             AND COALESCE(cd.dependencias, 0) >= 2 THEN 'alta'
        WHEN ap.semestre < da.semestre_ideal THEN 'media'
        WHEN ap.semestre = da.semestre_ideal THEN 'media'
        WHEN COALESCE(cd.dependencias, 0) >= 2 THEN 'baja'
        ELSE 'ninguna'
    END AS nivel_criticidad

FROM asignaturas_pendientes ap
CROSS JOIN datos_alumno da
LEFT JOIN conteo_dependencias cd 
    ON cd.cod_asignatura = ap.cod_asignatura

WHERE
    nivel_criticidad <> 'ninguna';

